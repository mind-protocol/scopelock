# Render Deployment Configuration
# https://render.com/docs/yaml-spec

services:
  # PostgreSQL Database (Free tier: 90 days, then $7/month)
  - type: pserv
    name: scopelock-db
    plan: free  # Free tier available
    region: oregon
    env: postgresql
    databases:
      - name: scopelock
        user: scopelock

  # FastAPI Backend
  - type: web
    name: scopelock-backend
    runtime: python
    plan: starter  # $7/month - upgrade to standard ($25/month) if needed
    region: oregon
    branch: main
    rootDir: backend
    buildCommand: "pip install --upgrade pip && pip install -r requirements.txt"
    startCommand: "uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 2"

    envVars:
      # API Keys (set these in Render dashboard - NOT in git)
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_CHAT_ID
        sync: false

      # Database (auto-generated by Render when linking)
      - key: DATABASE_URL
        fromDatabase:
          name: scopelock-db
          property: connectionString

      # Python Config
      - key: PYTHON_VERSION
        value: "3.11"
      - key: PYTHONUNBUFFERED
        value: "1"

      # App Config
      - key: LOG_LEVEL
        value: "INFO"
      - key: ENVIRONMENT
        value: "production"

    # Health checks
    healthCheckPath: /health

    # Autoscaling (optional - only on Standard plan+)
    # autoDeploy: true
    # numInstances: 1

    # Build settings
    buildFilter:
      paths:
        - backend/**
