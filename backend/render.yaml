# Render Deployment Configuration
# https://render.com/docs/yaml-spec
#
# 2-service architecture: Python backend + Node.js Rafael runner
# Cost: $7/month Ã— 2 = $14/month (NO DATABASE)

services:
  # 1. Python Backend (FastAPI)
  - type: web
    name: scopelock-backend
    runtime: python
    plan: starter  # $7/month
    region: oregon
    branch: main
    rootDir: backend
    buildCommand: "pip install --upgrade pip && pip install -r requirements.txt"
    startCommand: "uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 2"

    # Persistent disk for file storage (drafts, events)
    disk:
      name: scopelock-data
      mountPath: /var/data
      sizeGB: 1  # Free: 1GB included

    envVars:
      # Required (set in Render dashboard - NOT in git)
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_CHAT_ID
        sync: false
      - key: WEBHOOK_SECRET
        sync: false

      # Service URLs (set after deploying both services)
      - key: CITIZEN_RUNNER_URL
        value: "https://scopelock-citizen-runner.onrender.com"
      - key: BACKEND_API_URL
        value: "https://scopelock.onrender.com"

      # Python Config
      - key: PYTHONUNBUFFERED
        value: "1"

      # App Config
      - key: LOG_LEVEL
        value: "INFO"
      - key: ENVIRONMENT
        value: "production"

    # Health checks
    healthCheckPath: /health

    # Build settings
    buildFilter:
      paths:
        - backend/**

  # 2. Node.js Citizen Runner (Claude CLI)
  - type: web
    name: scopelock-citizen-runner
    runtime: node
    plan: starter  # $7/month
    region: oregon
    branch: main
    rootDir: citizen-runner
    buildCommand: "npm install && npm install -g @anthropic-ai/claude-code"
    startCommand: "node index.js"

    envVars:
      # Service URLs
      - key: BACKEND_API_URL
        value: "https://scopelock.onrender.com"

      # Paths (full repo deployed to /opt/render/project/src)
      - key: REPO_PATH
        value: "/opt/render/project/src"

      # Timeout
      - key: TIMEOUT_MS
        value: "120000"  # 2 minutes

      # Node Config
      - key: NODE_ENV
        value: "production"

    # Health checks
    healthCheckPath: /health

    # Build settings
    buildFilter:
      paths:
        - citizen-runner/**
        - citizens/**
