/*
 * Migration 004: Seed test data for development
 *
 * DOCUMENTATION REFERENCES:
 * ========================
 * Primary:
 * - docs/missions/mission-deck/architecture/06_database_schema.md (Section: "Seed Data")
 *
 * Secondary:
 * - All architecture docs (uses all tables)
 *
 * TEST FILES:
 * ===========
 * Seed Verification Tests:
 * - backend/tests/test_seed_data.py (verify_seed_data_exists)
 *
 * IMPLEMENTATION NOTES:
 * ====================
 * Purpose:
 * - Seed database with test data for local development
 * - Enables testing of all features without manual data entry
 *
 * Data Seeded:
 * 1. missions (2 missions with GitHub URLs)
 * 2. dod_items (10 items across 2 missions)
 * 3. chat_messages (5 messages for Rafael, 3 for Sofia)
 * 4. test_runs (2 test runs for mission 47)
 *
 * IMPORTANT:
 * - This migration should ONLY run in development/staging
 * - DO NOT run in production (use --exclude-seed flag)
 *
 * Rollback:
 * - DELETE all seeded data (by IDs)
 *
 * Dependencies:
 * - Requires migrations 001, 002, 003 to be applied
 */

-- ============================================================================
-- SEED DATA: MISSIONS
-- ============================================================================

-- Mission 47: Telegram Notifier
INSERT INTO missions (id, title, client, budget, deadline, status, assigned_to, github_url, created_at)
VALUES (
  '47',
  'Telegram Notifier',
  'Acme Corp',
  300,
  '2025-11-08 23:59:59',
  'active',
  'person1@scopelock.ai',
  'https://github.com/mind-protocol/mission-47',
  NOW()
)
ON CONFLICT (id) DO NOTHING;

-- Mission 48: Landing Page
INSERT INTO missions (id, title, client, budget, deadline, status, assigned_to, github_url, created_at)
VALUES (
  '48',
  'Landing Page',
  'Beta Inc',
  450,
  '2025-11-10 23:59:59',
  'active',
  'person1@scopelock.ai',
  'https://github.com/mind-protocol/mission-48',
  NOW()
)
ON CONFLICT (id) DO NOTHING;

-- ============================================================================
-- SEED DATA: DOD ITEMS
-- ============================================================================

-- Mission 47: Functional Requirements
INSERT INTO dod_items (id, mission_id, text, category, completed, completed_at)
VALUES
  ('dod-47-1', '47', 'User can send messages', 'functional', true, NOW() - INTERVAL '1 day'),
  ('dod-47-2', '47', 'Messages persist in database', 'functional', true, NOW() - INTERVAL '1 day'),
  ('dod-47-3', '47', 'Rafael responds with code blocks', 'functional', false, NULL),
  ('dod-47-4', '47', 'Code blocks have syntax highlighting', 'functional', false, NULL)
ON CONFLICT (id) DO NOTHING;

-- Mission 47: Non-Functional Requirements
INSERT INTO dod_items (id, mission_id, text, category, completed, completed_at)
VALUES
  ('dod-47-5', '47', 'Response time <2s (p95)', 'non-functional', true, NOW() - INTERVAL '1 day'),
  ('dod-47-6', '47', 'Lighthouse score â‰¥90', 'non-functional', true, NOW() - INTERVAL '1 day'),
  ('dod-47-7', '47', 'Bundle size <150KB gzipped', 'non-functional', false, NULL)
ON CONFLICT (id) DO NOTHING;

-- Mission 47: Tests
INSERT INTO dod_items (id, mission_id, text, category, completed, completed_at)
VALUES
  ('dod-47-8', '47', 'Unit tests pass', 'tests', true, NOW() - INTERVAL '1 day'),
  ('dod-47-9', '47', 'Integration tests pass', 'tests', true, NOW() - INTERVAL '1 day'),
  ('dod-47-10', '47', 'Performance tests pass', 'tests', false, NULL)
ON CONFLICT (id) DO NOTHING;

-- ============================================================================
-- SEED DATA: CHAT MESSAGES
-- ============================================================================

-- Rafael chat (Mission 47)
INSERT INTO chat_messages (id, mission_id, citizen, sender, message, code_blocks, created_at)
VALUES
  ('msg-47-1', '47', 'rafael', 'user', 'Can you generate the login API?', NULL, NOW() - INTERVAL '2 hours'),
  ('msg-47-2', '47', 'rafael', 'citizen', 'Here''s the complete login API implementation:\n\n```python\n@router.post(''/login'')\nasync def login(...):\n    ...\n```', '[{"language": "python", "code": "@router.post(''/login'')\nasync def login(...):\n    ..."}]'::jsonb, NOW() - INTERVAL '2 hours'),
  ('msg-47-3', '47', 'rafael', 'user', 'Can you add password hashing?', NULL, NOW() - INTERVAL '1 hour'),
  ('msg-47-4', '47', 'rafael', 'citizen', 'Sure! Here''s the updated implementation with bcrypt:\n\n```python\nimport bcrypt\n...\n```', '[{"language": "python", "code": "import bcrypt\n..."}]'::jsonb, NOW() - INTERVAL '1 hour')
ON CONFLICT (id) DO NOTHING;

-- Sofia chat (Mission 47)
INSERT INTO chat_messages (id, mission_id, citizen, sender, message, code_blocks, created_at)
VALUES
  ('msg-47-5', '47', 'sofia', 'user', 'Are the performance tests passing?', NULL, NOW() - INTERVAL '30 minutes'),
  ('msg-47-6', '47', 'sofia', 'citizen', 'The functional tests are passing (8/10), but 1 performance test is failing. The p95 response time is 2.3s, which exceeds the 2s threshold.', NULL, NOW() - INTERVAL '30 minutes'),
  ('msg-47-7', '47', 'sofia', 'user', 'Should I ask Rafael to optimize it?', NULL, NOW() - INTERVAL '20 minutes')
ON CONFLICT (id) DO NOTHING;

-- ============================================================================
-- SEED DATA: TEST RUNS
-- ============================================================================

-- Test run 1 (passed, 1 day ago)
INSERT INTO test_runs (id, mission_id, status, summary, results, logs, created_at)
VALUES (
  'run-47-1',
  '47',
  'passed',
  '{"functional_passed": 10, "functional_total": 10, "performance_passed": 3, "performance_total": 3}'::jsonb,
  '[
    {"name": "test_send_message", "status": "passed", "duration": 0.5},
    {"name": "test_receive_response", "status": "passed", "duration": 0.8}
  ]'::jsonb,
  'All tests passed',
  NOW() - INTERVAL '1 day'
)
ON CONFLICT (id) DO NOTHING;

-- Test run 2 (failed, 1 hour ago)
INSERT INTO test_runs (id, mission_id, status, summary, results, logs, created_at)
VALUES (
  'run-47-2',
  '47',
  'failed',
  '{"functional_passed": 8, "functional_total": 10, "performance_passed": 2, "performance_total": 3}'::jsonb,
  '[
    {"name": "test_send_message", "status": "passed", "duration": 0.5},
    {"name": "test_callback_handler", "status": "failed", "error": "KeyError: ''callback_data''", "duration": 0.1},
    {"name": "test_code_blocks", "status": "failed", "error": "Syntax highlighting missing", "duration": 0.2},
    {"name": "test_performance_p95", "status": "failed", "error": "p95 = 2.3s (threshold: 2s)", "duration": 5.0}
  ]'::jsonb,
  'Functional: 8/10 passed, Performance: 2/3 passed',
  NOW() - INTERVAL '1 hour'
)
ON CONFLICT (id) DO NOTHING;

-- ============================================================================
-- MIGRATION DOWN (Rollback)
-- ============================================================================

-- Uncomment below for rollback script
-- DELETE FROM test_runs WHERE id IN ('run-47-1', 'run-47-2');
-- DELETE FROM chat_messages WHERE mission_id IN ('47', '48');
-- DELETE FROM dod_items WHERE mission_id IN ('47', '48');
-- DELETE FROM missions WHERE id IN ('47', '48');

-- ============================================================================
-- TESTS TO IMPLEMENT
-- ============================================================================

/*
 * Seed Verification Tests (test_seed_data.py):
 *
 * test_seed_missions_exist():
 *   - Given: Migration 004 is applied
 *   - When: SELECT * FROM missions WHERE id IN ('47', '48')
 *   - Then: Returns 2 missions
 *
 * test_seed_dod_items_exist():
 *   - Given: Migration 004 is applied
 *   - When: SELECT * FROM dod_items WHERE mission_id = '47'
 *   - Then: Returns 10 DoD items
 *
 * test_seed_chat_messages_exist():
 *   - Given: Migration 004 is applied
 *   - When: SELECT * FROM chat_messages WHERE mission_id = '47'
 *   - Then: Returns 7 messages (4 rafael, 3 sofia)
 *
 * test_seed_test_runs_exist():
 *   - Given: Migration 004 is applied
 *   - When: SELECT * FROM test_runs WHERE mission_id = '47'
 *   - Then: Returns 2 test runs
 */

-- ============================================================================
-- IMPLEMENTATION CHECKLIST
-- ============================================================================

/*
 * Week 1 MVP:
 * - [x] Seed data SQL defined
 * - [ ] Run migration in development
 * - [ ] Verify missions seeded (2 missions)
 * - [ ] Verify dod_items seeded (10 items)
 * - [ ] Verify chat_messages seeded (7 messages)
 * - [ ] Verify test_runs seeded (2 test runs)
 * - [ ] Test rollback works
 * - [ ] Seed verification tests passing
 * - [ ] Add --exclude-seed flag to production migrations
 */

-- ============================================================================
-- USAGE NOTES
-- ============================================================================

/*
 * Run seed migration (development only):
 *
 * psql -U user -d scopelock_deck -f 004_seed_test_data.sql
 *
 * Skip seed migration in production:
 *
 * # Add to deployment script:
 * if [ "$ENV" != "production" ]; then
 *   psql -f 004_seed_test_data.sql
 * fi
 */
